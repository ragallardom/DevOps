name: Release - Build & Push

on:
  workflow_run:
    workflows: ["CI - Build, Test & JaCoCo, Snyk y Sonar"]
    types: [completed]

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

env:
  DOCKER_IMG: ${{ vars.DOCKER_IMG }}
  PROJECT_DIR: ${{ vars.PROJECT_DIR }}

jobs:
  build-push:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        env:
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          SHA_TAG=${HEAD_SHA::7}
          echo "TAG=sha-${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "Computed tag: $(cat "$GITHUB_OUTPUT" || true)"

      - name: Build & Push image (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.PROJECT_DIR }}
          file: ${{ env.PROJECT_DIR }}/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKER_IMG }}:${{ steps.tags.outputs.TAG }}
            ${{ env.DOCKER_IMG }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
